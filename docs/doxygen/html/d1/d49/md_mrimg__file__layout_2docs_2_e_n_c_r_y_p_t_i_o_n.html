<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.10.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Macrium Image File Layout: ENCRYPTION</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<script type="text/javascript" src="../../clipboard.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript" src="../../cookie.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../ReflectX_small.png"/></td>
  <td id="projectalign">
   <div id="projectname">Macrium Image File Layout
   </div>
   <div id="projectbrief">Source Documentation</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('d1/d49/md_mrimg__file__layout_2docs_2_e_n_c_r_y_p_t_i_o_n.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">ENCRYPTION</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><img src="../../../assets/ReflectX.png" alt="" width="300" class="inline"/> <br  />
Experience data independence with love, from us to you. <img src="../../../assets/Love_Heart_symbol.svg" alt="" style="pointer-events: none;" width="30" class="inline"/></p>
<hr  />
<h2><a class="anchor" id="autotoc_md0"></a>
Encryption Implementation Overview for Macrium Reflect X</h2>
<p>Macrium Reflect uses AES-CBC encryption, PBKDF2 for secure password handling, and SHA-256 hashing. AES-CBC (Advanced Encryption Standard in Cipher Block Chaining mode) provides a high level of encryption, making it practically impervious to decryption attempts without the correct key. PBKDF2 (Password-Based Key Derivation Function 2) is used to securely transform your password into a robust key by applying a hashing function, in this case, SHA-256 (Secure Hash Algorithm 256 bits), multiple times. This process significantly enhances the resistance against brute-force attacks. Furthermore, Macrium Reflect stores your password as an HMAC (Hash-Based Message Authentication Code) using SHA-256, a procedure that validates the integrity and authenticity of stored data, ensuring that your backups remain both secure and accessible only to those with the correct credentials.</p>
<p>Macrium Reflect offers AES-128, AES-192, and AES-256 encryption, enabling you to align with both regulatory compliance standards and performance needs. </p>
<h4><a class="anchor" id="autotoc_md1"></a>
AES-CBC:</h4>
<p>AES-CBC is a secure encryption algorithm where each plaintext cipher block is XORed (exclusive or operation) with the previous ciphertext block before being encrypted This approach allows for high levels of security and performance, making it an ideal choice for encrypting discrete data blocks for random access.</p>
<h4><a class="anchor" id="autotoc_md2"></a>
Initialization Vector</h4>
<p>The Initialization Vector (IV) is crucial in the AES-CBC mode for ensuring the uniqueness of each encrypted data block within a backup set.</p>
<p>There are 5 elements used for each IV:</p>
<ol type="1">
<li>The "imageid" is a unique, randomly generated identifier for each backup set, found in the header's JSON data, ensuring no duplicates across backup sets. <div class="fragment"><div class="line">&quot;_header&quot;: {</div>
<div class="line">    &quot;backup_guid&quot;: &quot;89a54134-2f03-4ed4-9ab7-139a165326a5&quot;,</div>
<div class="line">    &quot;backup_time&quot;: 1709555568,</div>
<div class="line">    &quot;backupset_time&quot;: 1709555568,</div>
<div class="line">    &quot;file_number&quot;: 0,</div>
<div class="line">    &quot;imaged_disks_count&quot;: 1,</div>
<div class="line">    `&quot;imageid&quot;:` &quot;0AD2FD9362D493B1&quot;,</div>
<div class="line">    &quot;increment_number&quot;: 0,</div>
<div class="line">    &quot;netbios_name&quot;: &quot;MS-W-0&quot;,</div>
<div class="line">    &quot;split_file&quot;: false</div>
<div class="line">},</div>
</div><!-- fragment --></li>
<li>The Disk number in the backup. <div class="fragment"><div class="line">&quot;disks&quot;: [</div>
<div class="line">    {</div>
<div class="line">        &quot;_header&quot;: {</div>
<div class="line">            &quot;disk_format&quot;: &quot;gpt&quot;,</div>
<div class="line">            `&quot;disk_number&quot;`: 2,</div>
<div class="line">            &quot;disk_signature&quot;: &quot;6A578E4D-7B5C-4CC1-85D3-FFCA233A9B93&quot;,</div>
<div class="line">            &quot;imaged_partition_count&quot;: 1</div>
<div class="line">        },</div>
<div class="line">    }</div>
<div class="line">]</div>
</div><!-- fragment --></li>
<li>The <a class="el" href="../../d6/d1d/struct_partition.html">Partition</a> number in the backup. <div class="fragment"><div class="line">&quot;partitions&quot;: [</div>
<div class="line">    {</div>
<div class="line">        &quot;_header&quot;: {</div>
<div class="line">            &quot;block_count&quot;: 1965792,</div>
<div class="line">            &quot;block_size&quot;: 65536,</div>
<div class="line">            &quot;file_history&quot;: [</div>
<div class="line">                {</div>
<div class="line">                    &quot;file_name&quot;: &quot;B:\\vx\\D684BA87241263E2-demo-00-00.mrimg&quot;,</div>
<div class="line">                    &quot;file_number&quot;: 0</div>
<div class="line">                }</div>
<div class="line">            ],</div>
<div class="line">            &quot;file_history_count&quot;: 1,</div>
<div class="line">            &quot;partition_file_offset&quot;: 0,</div>
<div class="line">            `&quot;partition_number&quot;`: 1</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">]</div>
</div><!-- fragment --></li>
<li>The index number of the block being encrypted.</li>
<li>Derived Key for ESSIV: Used for ESSIV (Encrypted Salt-Sector Initialization Vector) initialization to counter watermarking attacks.</li>
</ol>
<p>Using OpenSSL: </p><div class="fragment"><div class="line"> ++</div>
<div class="line">uint8_t* <a class="code hl_function" href="../../da/d8f/encryption_8cpp.html#a51f55c1998048f2ffb88ca23ebe453bd">formatInitializationVectorForAES</a>(<span class="keyword">const</span> uint8_t* imageid, <span class="keyword">const</span> int32_t disk_number, <span class="keyword">const</span> int32_t partition_number, <span class="keyword">const</span> int32_t block_index, <span class="keyword">const</span> std::array&lt;uint8_t, KEY_LENGTH&gt;&amp; DerivedKey, uint8_t* pIV)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Prepare the IV with a set/disk/partition/block - unique IV</span></div>
<div class="line">    <span class="comment">// using the imageid, disk_number, partition_number and block_index</span></div>
<div class="line">    uint8_t data[<a class="code hl_variable" href="../../d6/ddf/encryption_8h.html#a0465d2dd7119004cc36da97a066a011b">AES_BLOCK_SIZE</a>];</div>
<div class="line">    memcpy(data, imageid, 8); <span class="comment">// Copy &#39;imageid&#39; array into the &#39;data&#39; array</span></div>
<div class="line">    memcpy(data + 8, &amp;((<span class="keywordtype">byte</span>)disk_number), 2); <span class="comment">// Copy the value of &#39;disk_number&#39; into the &#39;data&#39; array starting at the 9th byte (index 8). &#39;disk_number&#39; is a 16-bit integer (2 bytes)</span></div>
<div class="line">    memcpy(data + 10, &amp;((<span class="keywordtype">byte</span>)partition_number), 2); <span class="comment">// Copy the value of &#39;partition_number&#39; into the &#39;data&#39; array starting at the 11th byte (index 10). &#39;partition_number&#39; is a 16-bit integer (2 bytes)</span></div>
<div class="line">    memcpy(data + 12, &amp;block_index, 4); <span class="comment">// Copy the value of &#39;block_index&#39; into the &#39;data&#39; array starting at the 13th byte (index 12). &#39;block_index&#39; is a 32-bit integer (4 bytes)</span></div>
<div class="line">    <span class="comment">// Hash the derived key</span></div>
<div class="line">    uint8_t key_hash[SHA256_DIGEST_LENGTH];</div>
<div class="line">    SHA256(DerivedKey.data(), DerivedKey.size(), key_hash); <span class="comment">// Compute SHA-256 hash of the derived key</span></div>
<div class="line">    <span class="comment">// Create a new cipher context</span></div>
<div class="line">    std::unique_ptr&lt;EVP_CIPHER_CTX, <span class="keyword">decltype</span>(&amp;::EVP_CIPHER_CTX_free)&gt; ctx(EVP_CIPHER_CTX_new(), ::EVP_CIPHER_CTX_free);</div>
<div class="line">    <span class="keywordflow">if</span> (!ctx) {</div>
<div class="line">        <span class="keywordflow">throw</span> std::runtime_error(<span class="stringliteral">&quot;Failed to create EVP_CIPHER_CTX&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">    <span class="comment">// Initialize the cipher context for AES-256 encryption in ECB mode</span></div>
<div class="line">    <span class="keywordflow">if</span> (EVP_EncryptInit_ex(ctx.get(), EVP_aes_256_ecb(), NULL, key_hash, NULL) != 1) {</div>
<div class="line">        <span class="keywordflow">throw</span> std::runtime_error(<span class="stringliteral">&quot;Failed to initialize EVP_CIPHER_CTX&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordtype">int</span> len = 0;</div>
<div class="line">    <span class="comment">// Encrypt the data using the initialized context and the key hash</span></div>
<div class="line">    <span class="keywordflow">if</span> (EVP_EncryptUpdate(ctx.get(), pIV, &amp;len, data, <a class="code hl_variable" href="../../d6/ddf/encryption_8h.html#a0465d2dd7119004cc36da97a066a011b">AES_BLOCK_SIZE</a>) != 1) {</div>
<div class="line">        <span class="keywordflow">throw</span> std::runtime_error(<span class="stringliteral">&quot;Failed to encrypt data&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">    <span class="comment">// Clean up is handled by the unique_ptr</span></div>
<div class="line">    <span class="keywordflow">return</span> pIV; <span class="comment">// Return the pointer to the IV</span></div>
<div class="line">}</div>
<div class="ttc" id="aencryption_8cpp_html_a51f55c1998048f2ffb88ca23ebe453bd"><div class="ttname"><a href="../../da/d8f/encryption_8cpp.html#a51f55c1998048f2ffb88ca23ebe453bd">formatInitializationVectorForAES</a></div><div class="ttdeci">uint8_t * formatInitializationVectorForAES(const uint8_t *pImageID, const int32_t disk_number, const int32_t partition_number, const int32_t block_index, const int dwpbkdf2Iterations, const std::array&lt; uint8_t, KEY_LENGTH &gt; &amp;DerivedKey, uint8_t *pIV)</div><div class="ttdoc">Formats the Initialization Vector (IV) for AES encryption.</div><div class="ttdef"><b>Definition</b> <a href="../../da/d8f/encryption_8cpp_source.html#l00132">encryption.cpp:132</a></div></div>
<div class="ttc" id="aencryption_8h_html_a0465d2dd7119004cc36da97a066a011b"><div class="ttname"><a href="../../d6/ddf/encryption_8h.html#a0465d2dd7119004cc36da97a066a011b">AES_BLOCK_SIZE</a></div><div class="ttdeci">constexpr int AES_BLOCK_SIZE</div><div class="ttdef"><b>Definition</b> <a href="../../d6/ddf/encryption_8h_source.html#l00032">encryption.h:32</a></div></div>
</div><!-- fragment --><h4><a class="anchor" id="autotoc_md3"></a>
Key Derivation with PBKDF2</h4>
<p>To convert user-provided passwords into secure encryption keys, we use PBKDF2 (Password-Based Key Derivation Function 2). We exceed current security recommendations by using 600,000 iterations, and this number is periodically reviewed to ensure resistance against brute-force attacks.</p>
<p>Using OpenSSL: </p><div class="fragment"><div class="line"> ++</div>
<div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="../../da/d8f/encryption_8cpp.html#ac1df9d7ab15b08397eb144b548d35ed0">getDerivedKey</a>(<span class="keyword">const</span> uint8_t(&amp;imageid)[8], <span class="keyword">const</span> std::string&amp; strPassword, <span class="keyword">const</span> <span class="keywordtype">int</span> iterations, std::array&lt;uint8_t, KEY_LENGTH&gt;&amp; DerivedKey)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Hash the Image ID using SHA-256</span></div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> imageid_hash[SHA256_DIGEST_LENGTH];</div>
<div class="line">    <span class="keywordflow">if</span> (!EVP_Digest(imageid, <span class="keyword">sizeof</span>(imageid), imageid_hash, NULL, EVP_sha256(), NULL)) {</div>
<div class="line">        <span class="keywordflow">throw</span> std::runtime_error(<span class="stringliteral">&quot;Failed to compute hash of Image ID&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">    <span class="comment">// Use PKCS5_PBKDF2_HMAC to generate the derived key</span></div>
<div class="line">    <span class="comment">// strPassword.c_str() is the password from which to derive the key</span></div>
<div class="line">    <span class="comment">// -1 means the function will calculate the length of the password string</span></div>
<div class="line">    <span class="comment">// imageid_hash is the salt value for the PBKDF2 function</span></div>
<div class="line">    <span class="comment">// sizeof(imageid_hash) is the length of the salt</span></div>
<div class="line">    <span class="comment">// iterations is the number of iterations for the PBKDF2 function</span></div>
<div class="line">    <span class="comment">// EVP_sha256() is the hash function to use</span></div>
<div class="line">    <span class="comment">// KEY_LENGTH is the length of the derived key</span></div>
<div class="line">    <span class="comment">// key_array.data() is the buffer where the derived key will be stored</span></div>
<div class="line">    <span class="keywordflow">if</span> (PKCS5_PBKDF2_HMAC(strPassword.c_str(), -1, imageid_hash, <span class="keyword">sizeof</span>(imageid_hash), iterations, EVP_sha256(), <a class="code hl_variable" href="../../d6/ddf/encryption_8h.html#a8bc6047ebe0bd984ad1787d297eac97a">KEY_LENGTH</a>, DerivedKey.data()) != 1) {</div>
<div class="line">        <span class="keywordflow">throw</span> std::runtime_error(<span class="stringliteral">&quot;Failed to generate derived key&quot;</span>); <span class="comment">// Throw an error if the key generation failed</span></div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span>; </div>
<div class="line">}</div>
<div class="ttc" id="aencryption_8cpp_html_ac1df9d7ab15b08397eb144b548d35ed0"><div class="ttname"><a href="../../da/d8f/encryption_8cpp.html#ac1df9d7ab15b08397eb144b548d35ed0">getDerivedKey</a></div><div class="ttdeci">void getDerivedKey(const uint8_t(&amp;imageid)[8], const std::string &amp;strPassword, const int iterations, std::array&lt; uint8_t, KEY_LENGTH &gt; &amp;DerivedKey)</div><div class="ttdoc">Generates a derived key using PBKDF2 SHA-256.</div><div class="ttdef"><b>Definition</b> <a href="../../da/d8f/encryption_8cpp_source.html#l00174">encryption.cpp:174</a></div></div>
<div class="ttc" id="aencryption_8h_html_a8bc6047ebe0bd984ad1787d297eac97a"><div class="ttname"><a href="../../d6/ddf/encryption_8h.html#a8bc6047ebe0bd984ad1787d297eac97a">KEY_LENGTH</a></div><div class="ttdeci">constexpr int KEY_LENGTH</div><div class="ttdef"><b>Definition</b> <a href="../../d6/ddf/encryption_8h_source.html#l00035">encryption.h:35</a></div></div>
</div><!-- fragment --> <h3><a class="anchor" id="autotoc_md4"></a>
Validating user password attempts</h3>
<p>The password is securely stored by applying an HMAC (Hash-Based Message Authentication Code) using SHA-256 to a key derived from the original password. </p><div class="fragment"><div class="line">&quot;_encryption&quot;: {</div>
<div class="line">    &quot;aes_type&quot;: &quot;aes-256&quot;,</div>
<div class="line">    &quot;enable&quot;: true,</div>
<div class="line">    `&quot;hmac&quot;`: &quot;3f40170bef9287feb86e8a811453441259d81f2272d31f7c861644cddfd7b814&quot;,</div>
<div class="line">    &quot;key_derivation&quot;: &quot;pbkdf2&quot;,</div>
<div class="line">    &quot;key_iterations&quot;: 600000</div>
<div class="line">},</div>
</div><!-- fragment --><p> Using OpenSSL: </p><div class="fragment"><div class="line"> ++</div>
<div class="line"><span class="keyword">constexpr</span> <span class="keywordtype">int</span> <a class="code hl_variable" href="../../d6/ddf/encryption_8h.html#a8bc6047ebe0bd984ad1787d297eac97a">KEY_LENGTH</a> = 32;</div>
<div class="line"><span class="keywordtype">void</span> getKeyHMACSHA256(<span class="keyword">const</span> std::array&lt;uint8_t, KEY_LENGTH&gt;&amp; key_array, std::array&lt;uint8_t, SHA256_DIGEST_LENGTH&gt;&amp; hmac_array)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Create a new HMAC context</span></div>
<div class="line">    <span class="keyword">auto</span> ctx = std::unique_ptr&lt;EVP_MD_CTX, decltype(&amp;::EVP_MD_CTX_free)&gt;(EVP_MD_CTX_new(), ::EVP_MD_CTX_free);</div>
<div class="line">    <span class="keywordflow">if</span> (!ctx) {</div>
<div class="line">        <span class="keywordflow">throw</span> std::runtime_error(<span class="stringliteral">&quot;Failed to create EVP_MD_CTX&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">    <span class="comment">// Initialize the HMAC context with the key and the SHA256 algorithm</span></div>
<div class="line">    <span class="keyword">const</span> EVP_MD* md = EVP_sha256();</div>
<div class="line">    <span class="keywordflow">if</span> (EVP_DigestInit_ex(ctx.get(), md, NULL) != 1) {</div>
<div class="line">        <span class="keywordflow">throw</span> std::runtime_error(<span class="stringliteral">&quot;Failed to initialize EVP_MD_CTX&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">    <span class="comment">// Create an EVP_PKEY structure from the key</span></div>
<div class="line">    <span class="keyword">auto</span> pkey = std::unique_ptr&lt;EVP_PKEY, decltype(&amp;::EVP_PKEY_free)&gt;(EVP_PKEY_new_mac_key(EVP_PKEY_HMAC, NULL, key_array.data(), (<span class="keywordtype">int</span>)key_array.size()), ::EVP_PKEY_free);</div>
<div class="line">    <span class="keywordflow">if</span> (!pkey) {</div>
<div class="line">        <span class="keywordflow">throw</span> std::runtime_error(<span class="stringliteral">&quot;Failed to create EVP_PKEY&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">    <span class="comment">// Set the HMAC key</span></div>
<div class="line">    <span class="keywordflow">if</span> (EVP_DigestSignInit(ctx.get(), NULL, md, NULL, pkey.get()) != 1) {</div>
<div class="line">        <span class="keywordflow">throw</span> std::runtime_error(<span class="stringliteral">&quot;Failed to set HMAC key&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">    <span class="comment">// Compute the HMAC</span></div>
<div class="line">    <span class="keywordtype">size_t</span> len = SHA256_DIGEST_LENGTH;</div>
<div class="line">    <span class="keywordflow">if</span> (EVP_DigestSignFinal(ctx.get(), hmac_array.data(), &amp;len) != 1) {</div>
<div class="line">        <span class="keywordflow">throw</span> std::runtime_error(<span class="stringliteral">&quot;Failed to compute HMAC&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">}</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.10.0 </li>
  </ul>
</div>
</body>
</html>
