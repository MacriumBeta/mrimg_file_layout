<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.10.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Macrium Image File Layout: mrimg_file_layout/src/libs/restore/restore.cpp File Reference</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<script type="text/javascript" src="../../clipboard.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript" src="../../cookie.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../ReflectX_small.png"/></td>
  <td id="projectalign">
   <div id="projectname">Macrium Image File Layout
   </div>
   <div id="projectbrief">Source Documentation</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('dd/d4c/restore_8cpp.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div class="header">
  <div class="summary">
<a href="#nested-classes">Classes</a> &#124;
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle"><div class="title">restore.cpp File Reference</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><code>#include &quot;pch.h&quot;</code><br />
<code>#include &quot;.\zstd\zstd.h&quot;</code><br />
<code>#include &quot;<a class="el" href="../../d0/de7/file__reader_8h_source.html">..\file_reader\file_reader.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="../../d2/d64/file__operations_8h_source.html">..\file_operations\file_operations.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="../../d6/ddf/encryption_8h_source.html">..\encryption\encryption.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="../../dc/d24/crc32_8h_source.html">crc32.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="../../d2/d8d/restore_8h_source.html">restore.h</a>&quot;</code><br />
</div>
<p><a href="../../dd/d4c/restore_8cpp_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="nested-classes" name="nested-classes"></a>
Classes</h2></td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d3/dd2/struct_encryption_i_v_params.html">EncryptionIVParams</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="func-members" name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a5f239ffbbf7c3fea0030b90339b8557a" id="r_a5f239ffbbf7c3fea0030b90339b8557a"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a5f239ffbbf7c3fea0030b90339b8557a">setNewDiskID</a> (<a class="el" href="../../d4/dcc/structfile__structs_1_1_disk_1_1_disk_layout.html">file_structs::Disk::DiskLayout</a> &amp;disk)</td></tr>
<tr class="memdesc:a5f239ffbbf7c3fea0030b90339b8557a"><td class="mdescLeft">&#160;</td><td class="mdescRight">Sets a new disk ID for the provided disk.  <br /></td></tr>
<tr class="separator:a5f239ffbbf7c3fea0030b90339b8557a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a14d084ad6486aedc539383123f3fb8a4" id="r_a14d084ad6486aedc539383123f3fb8a4"><td class="memItemLeft" align="right" valign="top">std::unique_ptr&lt; unsigned char[]&gt;&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a14d084ad6486aedc539383123f3fb8a4">readBlock</a> (<a class="el" href="../../d6/d6d/structfile__structs_1_1file_layout.html">file_structs::fileLayout</a> &amp;backupLayout, const <a class="el" href="../../d3/dd2/struct_encryption_i_v_params.html">EncryptionIVParams</a> &amp;ivParams, std::fstream *fileHandle, <a class="el" href="../../dd/dc8/structdata__block.html">data_block</a> &amp;block)</td></tr>
<tr class="memdesc:a14d084ad6486aedc539383123f3fb8a4"><td class="mdescLeft">&#160;</td><td class="mdescRight">Reads a block of data from a file, decrypts it if necessary, and decompresses it if it is compressed.  <br /></td></tr>
<tr class="separator:a14d084ad6486aedc539383123f3fb8a4"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:abf00213e6b79f9f1d5aced254654d509" id="r_abf00213e6b79f9f1d5aced254654d509"><td class="memItemLeft" align="right" valign="top">uint64_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#abf00213e6b79f9f1d5aced254654d509">calculateTotalBytes</a> (<a class="el" href="../../d6/d6d/structfile__structs_1_1file_layout.html">file_structs::fileLayout</a> &amp;fileLayout)</td></tr>
<tr class="memdesc:abf00213e6b79f9f1d5aced254654d509"><td class="mdescLeft">&#160;</td><td class="mdescRight">Calculates the total size of the backup.  <br /></td></tr>
<tr class="separator:abf00213e6b79f9f1d5aced254654d509"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a2b1e4ce944c7983f69c7f896ac00adef" id="r_a2b1e4ce944c7983f69c7f896ac00adef"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a2b1e4ce944c7983f69c7f896ac00adef">restoreDisk</a> (const std::wstring &amp;filePath, const std::string &amp;password, const std::wstring targetDisk, int diskNumber, bool keepDiskId, <a class="el" href="../../d2/d8d/restore_8h.html#a33abc204fe194611ab5559dd25517f7a">ProgressCallback</a> <a class="el" href="../../d4/dcf/console__print_8cpp.html#ada72cc4a4215fe3e5c8c3c1bbc11b277">outputProgress</a>)</td></tr>
<tr class="memdesc:a2b1e4ce944c7983f69c7f896ac00adef"><td class="mdescLeft">&#160;</td><td class="mdescRight">Restores a disk from a backup file.  <br /></td></tr>
<tr class="separator:a2b1e4ce944c7983f69c7f896ac00adef"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<h2 class="groupheader">Function Documentation</h2>
<a id="abf00213e6b79f9f1d5aced254654d509" name="abf00213e6b79f9f1d5aced254654d509"></a>
<h2 class="memtitle"><span class="permalink"><a href="#abf00213e6b79f9f1d5aced254654d509">&#9670;&#160;</a></span>calculateTotalBytes()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">uint64_t calculateTotalBytes </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="../../d6/d6d/structfile__structs_1_1file_layout.html">file_structs::fileLayout</a> &amp;</td>          <td class="paramname"><span class="paramname"><em>fileLayout</em></span></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Calculates the total size of the backup. </p>
<p>This function calculates the total size of the backup by summing up the lengths of all data blocks and reserved sector blocks in all partitions of all disks in the backup layout.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">fileLayout</td><td>The layout of the backup. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>The total size of the backup in bytes. </dd></dl>

<p class="definition">Definition at line <a class="el" href="../../dd/d4c/restore_8cpp_source.html#l00151">151</a> of file <a class="el" href="../../dd/d4c/restore_8cpp_source.html">restore.cpp</a>.</p>

</div>
</div>
<a id="a14d084ad6486aedc539383123f3fb8a4" name="a14d084ad6486aedc539383123f3fb8a4"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a14d084ad6486aedc539383123f3fb8a4">&#9670;&#160;</a></span>readBlock()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">std::unique_ptr&lt; unsigned char[]&gt; readBlock </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="../../d6/d6d/structfile__structs_1_1file_layout.html">file_structs::fileLayout</a> &amp;</td>          <td class="paramname"><span class="paramname"><em>backupLayout</em>, </span></td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="../../d3/dd2/struct_encryption_i_v_params.html">EncryptionIVParams</a> &amp;</td>          <td class="paramname"><span class="paramname"><em>ivParams</em>, </span></td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">std::fstream *</td>          <td class="paramname"><span class="paramname"><em>fileHandle</em>, </span></td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="../../dd/dc8/structdata__block.html">data_block</a> &amp;</td>          <td class="paramname"><span class="paramname"><em>block</em></span>&#160;)</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Reads a block of data from a file, decrypts it if necessary, and decompresses it if it is compressed. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">fileHandle</td><td>The handle to the file from which to read the block. </td></tr>
    <tr><td class="paramname">block</td><td>The block to read. </td></tr>
    <tr><td class="paramname">isCompressed</td><td>A flag indicating whether the block is compressed. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>A unique_ptr to the read (and possibly decrypted and decompressed) data. </dd></dl>

<p class="definition">Definition at line <a class="el" href="../../dd/d4c/restore_8cpp_source.html#l00091">91</a> of file <a class="el" href="../../dd/d4c/restore_8cpp_source.html">restore.cpp</a>.</p>

</div>
</div>
<a id="a2b1e4ce944c7983f69c7f896ac00adef" name="a2b1e4ce944c7983f69c7f896ac00adef"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a2b1e4ce944c7983f69c7f896ac00adef">&#9670;&#160;</a></span>restoreDisk()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void restoreDisk </td>
          <td>(</td>
          <td class="paramtype">const std::wstring &amp;</td>          <td class="paramname"><span class="paramname"><em>filePath</em>, </span></td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const std::string &amp;</td>          <td class="paramname"><span class="paramname"><em>password</em>, </span></td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const std::wstring</td>          <td class="paramname"><span class="paramname"><em>targetDisk</em>, </span></td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int</td>          <td class="paramname"><span class="paramname"><em>diskNumber</em>, </span></td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">bool</td>          <td class="paramname"><span class="paramname"><em>keepDiskId</em>, </span></td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="../../d2/d8d/restore_8h.html#a33abc204fe194611ab5559dd25517f7a">ProgressCallback</a></td>          <td class="paramname"><span class="paramname"><em>outputProgress</em></span>&#160;)</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Restores a disk from a backup file. </p>
<p>This function performs the following steps:</p><ol type="1">
<li>Opens the target disk file.</li>
<li>Reads the backup file layout.</li>
<li>Creates a backup set, which includes building an index and creating a map of file handles.</li>
<li>Calculates the total size of the backup.</li>
<li>Sets the file pointer to the beginning of the backup file.</li>
<li>Selects the disk for restoration based on the provided disk number.</li>
<li>Optionally sets a new disk ID to prevent a disk collision.</li>
<li>Writes the track0 data to the target disk.</li>
<li>If the disk format is MBR, restores the extended partition and logical drive boot records.</li>
<li>Loops through each partition in the disk to restore.</li>
<li>For each partition, writes FAT32 reserved sectors to the target disk.</li>
<li>Loops through each data block in the partition.</li>
<li>For each data block, reads the block data from the backup file.</li>
<li>Writes the block data to the target disk.</li>
<li>Outputs the progress of the restoration process.</li>
</ol>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">filePath</td><td>The path to the backup file. </td></tr>
    <tr><td class="paramname">password</td><td>The password for the backup file. </td></tr>
    <tr><td class="paramname">targetDiskHandle</td><td>The handle to the target disk where the backup is being restored. </td></tr>
    <tr><td class="paramname">diskNumber</td><td>The user provided disk number to restore. -1 if not supplied. </td></tr>
    <tr><td class="paramname">keepDiskId</td><td>A flag indicating whether to keep the disk ID the same or set a new one. </td></tr>
    <tr><td class="paramname">outputProgress</td><td>A callback function to output the progress of the restoration process. Default is nullptr. </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="../../dd/d4c/restore_8cpp_source.html#l00196">196</a> of file <a class="el" href="../../dd/d4c/restore_8cpp_source.html">restore.cpp</a>.</p>

</div>
</div>
<a id="a5f239ffbbf7c3fea0030b90339b8557a" name="a5f239ffbbf7c3fea0030b90339b8557a"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a5f239ffbbf7c3fea0030b90339b8557a">&#9670;&#160;</a></span>setNewDiskID()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void setNewDiskID </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="../../d4/dcc/structfile__structs_1_1_disk_1_1_disk_layout.html">file_structs::Disk::DiskLayout</a> &amp;</td>          <td class="paramname"><span class="paramname"><em>disk</em></span></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Sets a new disk ID for the provided disk. </p>
<p>This function checks if the disk format is GPT or MBR and sets a new unique identifier accordingly. For GPT, it creates a new GUID and assigns it to the disk_guid field of the GPT header. For MBR, it generates a new disk ID by getting the current tick count and writes it into the boot code of the MBR.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">disk</td><td>The disk for which to set a new ID. </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="../../dd/d4c/restore_8cpp_source.html#l00044">44</a> of file <a class="el" href="../../dd/d4c/restore_8cpp_source.html">restore.cpp</a>.</p>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../dir_88e100402737e4fa918e4aa5a7dba644.html">mrimg_file_layout</a></li><li class="navelem"><a class="el" href="../../dir_34285ecb0ee8fd6ba963d985ce135e66.html">src</a></li><li class="navelem"><a class="el" href="../../dir_89ba79a4af698e9a0f72a28273c38cea.html">libs</a></li><li class="navelem"><a class="el" href="../../dir_e3570ea87f4174441a9203ab2b6322c5.html">restore</a></li><li class="navelem"><a class="el" href="../../dd/d4c/restore_8cpp.html">restore.cpp</a></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.10.0 </li>
  </ul>
</div>
</body>
</html>
